## 基本信息

* 题目名称： [FSCTF 2023]加速加速
* 题目链接： https://www.nssctf.cn/problem/4629
* 考点清单： 条件竞争，文件上传
* 工具清单： yakit , burp
* payloads： 无

## 一、看到什么

**题目关键信息列表**：

1. 题目提示很明显，就是要上传webshell上去。

2. 上传的地方提示了要上传的是图片。

## 二、想到什么解题思路

1. 按照题目的意思上传图片，可以查看到文件的路径
2. 上传恶意文件并尝试绕过
3. 绕过无果尝试条件竞争

## 三、尝试过程和结果记录



**尝试过程：**

1. 尝试上传一张图片，分析请求和响应。
    - 可以看到文件上传路径，并且文件被重新命名。
    ![](images/[FSCTF%202023]加速加速-上传图片.png)
2. 尝试上传一个`php`文件，分析请求和响应。
    - 提示只能上传图片类型的文件。
    ![](images/[FSCTF%202023]加速加速-上传php.png)
3. 题目已经限定了类型，，没有`include`这样的函数来读取`php`文件内容，也没有给其他提示。

4. 考虑条件竞争。
    - 条件竞争:条件竞争是指一个系统的运行结果依赖于不受控制的事件的先后顺序。当这些不受控制的事件并没有按照开发者想要的方式运行时，就可能会出现bug。尤其在当前我们的系统中大量对资源进行共享，如果处理不当的话，就会产生条件竞争漏洞。
    - 开发人员通过检测文件后缀名，设置白名单黑名单各种方式判断用户上传文件是否为危险文件，一旦发现，就会立马发现。同样的，若是我们在判断和删除事件这一时间差内进行一些操作岂不是也会成功。

5. 使用`burp`的`intruder`功能，重复上传`php`文件。下述代码的作用就是写一句话木马到`2.php`文件中。

```php
<?php fputs(fopen("2.php", "w"), '<?php eval($_POST["cmd"]);?>'); ?>    
```
![](images/[FSCTF%202023]加速加速-重复上传php.png)


6. 与此同时，一直尝试去访问`1.php`这个文件，修改一个查看上传图片的请求包，改为访问`1.php`。同样不需要`payloads`。

![](images/[FSCTF%202023]加速加速-查看php.png)


7. 两者持续进行，观察访问`1.php`的包是否有状态码为`200`的响应，如果有则表明条件竞争成功。

![](images/[FSCTF%202023]加速加速-成功上传.png)

8. 接下来就可以通过蚁剑进行连接。

![](images/[FSCTF%202023]加速加速-蚁剑连接.png)
  
9. 访问根目录即可获取flag

![](images/[FSCTF%202023]加速加速-获取flag.png)

## 四、总结与反思

1. 条件竞争之所以产生，很大一部分原因是程序的逻辑性出现问题，开发人员习惯性的遵循线性思维进行代码编写，对线程并发操作没有采取同步制约的相关措施。上传文件时，对于这种夹缝中生存的漏洞，采取先检测后上传的的方式，直接堵死这条不安全的“缝”。

